---
title: Monte Carlo Simulation for City of Flagstaff Home Weatherization and Energy Rebate Program
author: Brandon McNamara
project: Dissertation chapter 3
date: March 19, 2025
---

Package Install & Load
```{r setup}
if (!require("dplyr")) install.packages("dplyr")
library(dplyr)
if (!require("tidyr")) install.packages("tidyr")
library(tidyr)
if (!require("readxl")) install.packages("readxl")
library(readxl)
if (!require("writexl")) install.packages("writexl")
library(writexl)
if (!require("ggplot2")) install.packages("ggplot2")
library(ggplot2)
if (!require("scales")) install.packages("scales")
library(scales)
if (!require("data.table")) install.packages("data.table")
library(data.table)
if (!require("gridExtra")) install.packages("gridExtra")
library(gridExtra)
if (!require("patchwork")) install.packages("patchwork")
library(patchwork)
```

Set up global variables
```{r}
# Define the following global variables to be called by parameter functions
run_count <- 1000
scenario_start <- 2025
intv_years <- 10 # The number of years the intervention will be implemented
intv_lifetime <- 15 # The number of years the intervention generates benefits, generally the expected lifetime of equipment
scenario_end  <- scenario_start + intv_years + intv_lifetime - 2
scenario_years <- scenario_end - scenario_start + 1
output_headers <- scenario_start:scenario_end
```

Initiate helper functions
```{r}
source("parameter_functions.r")
```

Create CO2e Emission Factor Library
```{r}
EFL_co2e("ar6")
write_xlsx(EFL, path = "EFLco2e.xlsx") 
```

Emission Factor Simulations
```{r}
# Electricity emission factor
scenario_MCS("ef_sim_electricity", sheet_name = "electricity_ef", units = "kgco2e/kWh") #write a custom function for electricity? with the starting value as a input? And NREL grid region as an input as well. 

# Supply Chain emission factor
continuous_uniform2("ef_sim_appliances_upstream", minvalue = 0.079, maxvalue = 0.161, units = "kgco2e/USD")
continuous_uniform2("ef_sim_weatherize_upstream", minvalue = 0.082, maxvalue = 0.208, units = "kgco2e/USD")

```

Boundary Simulations
```{r}
# Reference boundary represents zero energy efficiency upgrades in each year
static_value("ref_boundary_mgnl", 0, units = "project count")

# Intervention boundary is modeled as a random value between 120 and 160.
# The program is assumed to have funding for 10 years. After that, no more homes are funded. 
discrete_uniform3("intv_boundary_mgnl", minvalue = 120, maxvalue = 160, nyears = intv_years, value2 = 0, units = "project count")

# Project types are randomly assigned for the intervention boundary, with three new dataframes for each project type.
assign_projecttype(intv_boundary_mgnl)

# Energy Prices 
static_value("kwh_price", value = -0.1542, units = "USD")
static_value("therm_price", value = -0.3434, units = "therms")

```

Air source heat pumps (ASHP): Activity data, cost, and ghg simulations
```{r}
# Simulate reference scenario electricity consumption factor for space heating and cooling.
calc_ref("ashp_ref_ann_data1",
         ashp_boundary_mgnl,
         ref_pdf = rnorm,
         ref_params = list(mean = 4161, sd = 233),
         units = "kWh")

# Simulate reference scenario natural gas consumption factor for space heating and cooling.
calc_ref("ashp_ref_ann_data2",
         ashp_boundary_mgnl,
         ref_pdf = rnorm,
         ref_params = list(mean = 603, sd = 11.3),
         units = "therms")

# Simulate intervention energy savings from ASHP upgrade
cont_uniform1("ashp_intv_factor", minvalue = 0.31, maxvalue = 0.47, "% savings")

# Calculate intervention scenario energy consumption based on modeled savings
calc_intv("ashp_intv_ann_data1", ashp_ref_ann_data1, ashp_intv_factor, "kwh")
calc_intv("ashp_intv_ann_data2", ashp_ref_ann_data2, ashp_intv_factor, "therms")

# Calculate cumulative activity data based on scenario lifetime
cumul_sum2("ashp_ref_data1", ashp_ref_ann_data1)
cumul_sum2("ashp_ref_data2", ashp_ref_ann_data2)
cumul_sum2("ashp_intv_data1", ashp_intv_ann_data1)
cumul_sum2("ashp_intv_data2", ashp_intv_ann_data2)

# Simulate the capex costs for each home, for both scenarios
cont_uniform1("ashp_capex_factor1", minvalue = -6000, maxvalue = -2100, units = "USD")
df_mod("ashp_intv_capex1",ashp_capex_factor1, ashp_boundary_mgnl, operation = "*", units = "USD")
df_mod("ashp_ref_capex1",ashp_capex_factor1, ref_boundary_mgnl, operation = "*", units = "USD")

# Sum total Capex
df_sum("ashp_intv_capexsum", ashp_intv_capex1)
df_sum("ashp_ref_capexsum", ashp_ref_capex1)

# Calculate Opex (kwh)
df_mod("ashp_ref_opex1",ashp_ref_data1, kwh_price, operation = "*", units = "USD")
df_mod("ashp_intv_opex1",ashp_intv_data1, kwh_price, operation = "*", units = "USD")

# Calculate Opex (therms)
df_mod("ashp_ref_opex2",ashp_ref_data2, therm_price, operation = "*", units = "USD")
df_mod("ashp_intv_opex2",ashp_intv_data2, therm_price, operation = "*", units = "USD")

# Sum total opex
df_sum("ashp_ref_opexsum", ashp_ref_opex1, ashp_ref_opex2)
df_sum("ashp_intv_opexsum", ashp_intv_opex1, ashp_intv_opex2)

# Calculate scope 1 natural gas emissions 
ghg_conversion1("ashp_ref_ghg_natgas",
                "ashp_intv_ghg_natgas",
                ashp_ref_data2,
                ashp_intv_data2,
                fltr.ef_activeyear = 2024, 
                fltr.service_type = "natural gas", 
                fltr.emission_category = "stationary", 
                fltr.emission_scope = "scope 1",
                fltr.service_subcategory1 = "", 
                fltr.service_subcategory2 = "", 
                fltr.country = "global", 
                fltr.subregion = "")

# Calculate scope 2 electricity ghg emissions based on a simulation of grid emissions intensity
ghg_conversion2("ashp_ref_ghg_elec", "ashp_intv_ghg_elec", ef_sim_electricity, ashp_ref_data1, ashp_intv_data1)

# Calculate scope 3 supply chain ghg emissions based on a simulation of the upstream spend-based emission factor
ghg_conversion3("ashp_ref_ghg_upstream", "ashp_intv_ghg_upstream", ef_sim_appliances_upstream, ashp_ref_capex1, ashp_intv_capex1)

# Calculate total ashp GHG emissions
df_sum("ashp_ref_ghgsum", ashp_ref_ghg_natgas, ashp_ref_ghg_elec, ashp_ref_ghg_upstream)
df_sum("ashp_intv_ghgsum", ashp_intv_ghg_natgas, ashp_intv_ghg_elec, ashp_intv_ghg_upstream)

```

Weatherization: Activity data, cost, and GHG simulations
```{r}
# Simulate reference scenario electricity consumption factor for space heating and cooling.
calc_ref("weatherize_ref_ann_data1",
         weatherize_boundary_mgnl,
         ref_pdf = rnorm,
         ref_params = list(mean = 4161, sd = 233),
         units = "kWh")

# Simulate reference scenario natural gas consumption factor for space heating and cooling.
calc_ref("weatherize_ref_ann_data2",
         weatherize_boundary_mgnl,
         ref_pdf = rnorm,
         ref_params = list(mean = 603, sd = 11.3),
         units = "therms")

# Simulate intervention energy savings from weatherize upgrade
cont_uniform1("weatherize_intv_factor", minvalue = 0.10, maxvalue = 0.20, "% savings")

# Calculate intervention scenario energy consumption based on modeled savings
calc_intv("weatherize_intv_ann_data1", weatherize_ref_ann_data1, weatherize_intv_factor, "kwh")
calc_intv("weatherize_intv_ann_data2", weatherize_ref_ann_data2, weatherize_intv_factor, "therms")

# Calculate cumulative activity data based on scenario lifetime
cumul_sum2("weatherize_ref_data1", weatherize_ref_ann_data1)
cumul_sum2("weatherize_ref_data2", weatherize_ref_ann_data2)
cumul_sum2("weatherize_intv_data1", weatherize_intv_ann_data1)
cumul_sum2("weatherize_intv_data2", weatherize_intv_ann_data2)

# Simulate the capex costs for each home, for both scenarios
cont_uniform1("weatherize_capex_factor1", minvalue = -2962, maxvalue = -1879, units = "USD")
df_mod("weatherize_intv_capex1",weatherize_capex_factor1, weatherize_boundary_mgnl, operation = "*", units = "USD")
df_mod("weatherize_ref_capex1",weatherize_capex_factor1, ref_boundary_mgnl, operation = "*", units = "USD")

# Sum total Capex
df_sum("weatherize_intv_capexsum", weatherize_intv_capex1)
df_sum("weatherize_ref_capexsum", weatherize_ref_capex1)

# Calculate Opex (kwh)
df_mod("weatherize_ref_opex1",weatherize_ref_data1, kwh_price, operation = "*", units = "USD")
df_mod("weatherize_intv_opex1",weatherize_intv_data1, kwh_price, operation = "*", units = "USD")

# Calculate Opex (therms)
df_mod("weatherize_ref_opex2",weatherize_ref_data2, therm_price, operation = "*", units = "USD")
df_mod("weatherize_intv_opex2",weatherize_intv_data2, therm_price, operation = "*", units = "USD")

# Sum total opex
df_sum("weatherize_ref_opexsum", weatherize_ref_opex1, weatherize_ref_opex2)
df_sum("weatherize_intv_opexsum", weatherize_intv_opex1, weatherize_intv_opex2)

# Calculate scope 1 natural gas emissions 
ghg_conversion1("weatherize_ref_ghg_natgas",
                "weatherize_intv_ghg_natgas",
                weatherize_ref_data2,
                weatherize_intv_data2,
                fltr.ef_activeyear = 2024, 
                fltr.service_type = "natural gas", 
                fltr.emission_category = "stationary", 
                fltr.emission_scope = "scope 1",
                fltr.service_subcategory1 = "", 
                fltr.service_subcategory2 = "", 
                fltr.country = "global", 
                fltr.subregion = "")

# Calculate scope 2 electricity ghg emissions based on a simulation of grid emissions intensity
ghg_conversion2("weatherize_ref_ghg_elec", "weatherize_intv_ghg_elec", ef_sim_electricity, weatherize_ref_data1, weatherize_intv_data1)

# Calculate scope 3 supply chain ghg emissions based on a simulation of the upstream spend-based emission factor
ghg_conversion3("weatherize_ref_ghg_upstream", "weatherize_intv_ghg_upstream", ef_sim_weatherize_upstream, weatherize_ref_capex1, weatherize_intv_capex1)

# Calculate total weatherize GHG emissions
df_sum("weatherize_ref_ghgsum", weatherize_ref_ghg_natgas, weatherize_ref_ghg_elec, weatherize_ref_ghg_upstream)
df_sum("weatherize_intv_ghgsum", weatherize_intv_ghg_natgas, weatherize_intv_ghg_elec, weatherize_intv_ghg_upstream)

```

Heat Pump Water Heater (HPWH): Activity data, cost, and GHG simulations
```{r}
# Simulate reference scenario electricity consumption factor for space heating and cooling.
calc_ref("hpwh_ref_ann_data1",
         hpwh_boundary_mgnl,
         ref_pdf = rnorm,
         ref_params = list(mean = 2969, sd = 108.1),
         units = "kWh")

# Simulate reference scenario natural gas consumption factor for space heating and cooling.
calc_ref("hpwh_ref_ann_data2",
         hpwh_boundary_mgnl,
         ref_pdf = rnorm,
         ref_params = list(mean = 237, sd = 4),
         units = "therms")

# Simulate intervention energy savings from hpwh upgrade
cont_uniform1("hpwh_intv_factor", minvalue = 0.30, maxvalue = 0.70, "% savings")

# Calculate intervention scenario energy consumption based on modeled savings
calc_intv("hpwh_intv_ann_data1", hpwh_ref_ann_data1, hpwh_intv_factor, "kwh")
calc_intv("hpwh_intv_ann_data2", hpwh_ref_ann_data2, hpwh_intv_factor, "therms")

# Calculate cumulative activity data based on scenario lifetime
cumul_sum2("hpwh_ref_data1", hpwh_ref_ann_data1)
cumul_sum2("hpwh_ref_data2", hpwh_ref_ann_data2)
cumul_sum2("hpwh_intv_data1", hpwh_intv_ann_data1)
cumul_sum2("hpwh_intv_data2", hpwh_intv_ann_data2)

# Simulate the capex costs for each home, for both scenarios
cont_uniform1("hpwh_capex_factor1", minvalue = -2900, maxvalue = -1300, units = "USD")
df_mod("hpwh_intv_capex1",hpwh_capex_factor1, hpwh_boundary_mgnl, operation = "*", units = "USD")
df_mod("hpwh_ref_capex1",hpwh_capex_factor1, ref_boundary_mgnl, operation = "*", units = "USD")

# Sum total Capex
df_sum("hpwh_intv_capexsum", hpwh_intv_capex1)
df_sum("hpwh_ref_capexsum", hpwh_ref_capex1)

# Calculate Opex (kwh)
df_mod("hpwh_ref_opex1",hpwh_ref_data1, kwh_price, operation = "*", units = "USD")
df_mod("hpwh_intv_opex1",hpwh_intv_data1, kwh_price, operation = "*", units = "USD")

# Calculate Opex (therms)
df_mod("hpwh_ref_opex2",hpwh_ref_data2, therm_price, operation = "*", units = "USD")
df_mod("hpwh_intv_opex2",hpwh_intv_data2, therm_price, operation = "*", units = "USD")

# Sum total opex
df_sum("hpwh_ref_opexsum", hpwh_ref_opex1, hpwh_ref_opex2)
df_sum("hpwh_intv_opexsum", hpwh_intv_opex1, hpwh_intv_opex2)

# Calculate scope 1 natural gas emissions 
ghg_conversion1("hpwh_ref_ghg_natgas",
                "hpwh_intv_ghg_natgas",
                hpwh_ref_data2,
                hpwh_intv_data2,
                fltr.ef_activeyear = 2024, 
                fltr.service_type = "natural gas", 
                fltr.emission_category = "stationary", 
                fltr.emission_scope = "scope 1",
                fltr.service_subcategory1 = "", 
                fltr.service_subcategory2 = "", 
                fltr.country = "global", 
                fltr.subregion = "")

# Calculate scope 2 electricity ghg emissions based on a simulation of grid emissions intensity
ghg_conversion2("hpwh_ref_ghg_elec", "hpwh_intv_ghg_elec", ef_sim_electricity, hpwh_ref_data1, hpwh_intv_data1)

# Calculate scope 3 supply chain ghg emissions based on a simulation of the upstream spend-based emission factor
ghg_conversion3("hpwh_ref_ghg_upstream", "hpwh_intv_ghg_upstream", ef_sim_appliances_upstream, hpwh_ref_capex1, hpwh_intv_capex1)

# Calculate total hpwh GHG emissions
df_sum("hpwh_ref_ghgsum", hpwh_ref_ghg_natgas, hpwh_ref_ghg_elec, hpwh_ref_ghg_upstream)
df_sum("hpwh_intv_ghgsum", hpwh_intv_ghg_natgas, hpwh_intv_ghg_elec, hpwh_intv_ghg_upstream)

```

Calculate GHG Mitigation
```{r}
# calculate total reference GHG emissions
ref_ghgsum <- (ashp_ref_ghgsum[, -1] + weatherize_ref_ghgsum[, -1] + hpwh_ref_ghgsum[, -1])/1000
ref_ghgsum <- ref_ghgsum %>%
    mutate(unit = "mtco2e") %>%  
    select(unit, everything())  

# calculate total intervention GHG emissions
intv_ghgsum <- (ashp_intv_ghgsum[, -1] + weatherize_intv_ghgsum[, -1] + hpwh_intv_ghgsum[, -1])/1000
intv_ghgsum <- intv_ghgsum %>%
    mutate(unit = "mtco2e") %>%  #
    select(unit, everything())  

# Calculate GHG mitigation
ghg_mitigation <- ref_ghgsum[, -1] - intv_ghgsum[, -1]
ghg_mitigation <- ghg_mitigation %>%
    mutate(unit = "mtco2e") %>%  
    select(unit, everything())  

```

Calculate total costs and co-benefits
```{r}
# Calculate total reference scenario costs
df_sum("ref_opexsum", ashp_ref_opexsum, weatherize_ref_opexsum, hpwh_ref_opexsum)
df_sum("ref_capexsum", ashp_ref_capexsum, weatherize_ref_capexsum, hpwh_ref_capexsum)
df_sum("ref_costs_econ", ref_opexsum, ref_capexsum)

# Calculate total intervention scenario costs
df_sum("intv_opexsum", ashp_intv_opexsum, weatherize_intv_opexsum, hpwh_intv_opexsum)
df_sum("intv_capexsum", ashp_intv_capexsum, weatherize_intv_capexsum, hpwh_intv_capexsum)
df_sum("intv_costs_econ", intv_opexsum, intv_capexsum)

# Social cost of carbon (SCC) is modeled as a normal distribution. It's modeled as an avoided cost, so a positive value is used. 
# mean = $185 sd = $85.7
# The selected value for each simulation is applied consistently over the scenario lifetime.
normal_PDF("coben1_sim", 185, 85.7, units = "USD/mtco2e")

# The function above leads to negative values for the social cost of carbon. In practice, this does not make sense. So negative values are converted to 0 below
coben1_sim[coben1_sim < 0] <- 0

# Calculate social value from Parameter 1 co-benefits 
df_mod("coben_value",ghg_mitigation, coben1_sim, operation = "*", units = "social value of avoided carbon (USD)")

# Discount co-benefits
quick_discount("coben_pv", "scc_dr_out", coben_value, dr = 2)

# Calculate cashflow
df_mod("cashflow_investment",intv_capexsum, ref_capexsum, operation = "-", units = "USD") # Assuming capex costs = investment costs
df_mod("cashflow_opex",intv_opexsum, ref_opexsum, operation = "-", units = "USD")
df_mod("cashflow_econ",intv_costs_econ, ref_costs_econ, operation = "-", units = "USD")
df_mod("cashflow_social",cashflow_econ, coben_pv, operation = "+", units = "USD")
cashflow_private <- cashflow_econ # This is a space holder for now. Private cost is built into the function, but is not part of this case study

```

Figure 2: Electricity EF
```{r}
# Electricity scenarios
elec_ef_scenarios <- read_excel("scenarios.xlsx", sheet = "electricity_ef")
fig2_trim <- cbind(elec_ef_scenarios[, 3], elec_ef_scenarios[, 9:34])
fig2_data <- fig2_trim %>%
  pivot_longer(cols = starts_with("20"), 
               names_to = "year", 
               values_to = "value")
fig2_data$year <- as.numeric(fig2_data$year)
colnames(fig2_data)[1] <- "scenario"

p2_scenario_order <- c("Mid-case", 
                    "Low Renewable Energy Costs", 
                    "High Renewable Energy Costs", 
                    "Low Natural Gas Prices", 
                    "High Natural Gas Prices", 
                    "High Demand Growth", 
                    "95% Decarbonization by 2050", 
                    "100% Decarbonization by 2035")

p2_colors <- c(
  "Mid-case" = "#1F77B4",  # Blue
  "Low Renewable Energy Costs" = "#FF7F0E",  # Orange
  "High Renewable Energy Costs" = "#2CA02C",  # Green
  "Low Natural Gas Prices" = "#D62728",  # Red
  "High Natural Gas Prices" = "#9467BD",  # Purple
  "High Demand Growth" = "#8C564B",  # Brown
  "95% Decarbonization by 2050" = "#E377C2",  # Light Purple
  "100% Decarbonization by 2035" = "#7F7F7F"  # Gray
)

p2 <- ggplot(fig2_data, aes(x = year, y = value, color = scenario, group = scenario)) +
  geom_line(size = 1) +
  labs(title = NULL, 
       x = "Year", y = "kgco2e/kWh", color = "Scenario") +
  scale_color_manual(
    values = p2_colors,
    breaks = p2_scenario_order) +
  theme_minimal() +
  theme(text = element_text(size = 8, color = "black"),
        plot.title = element_text(face = "bold", size = 12, color = "black"),
        axis.text = element_text(size = 8, color = "black"),
        axis.title = element_text(size = 8, color = "black"),
        legend.text = element_text(size = 8, color = "black"),
        axis.ticks = element_line(color = "black", linewidth = .5),
        axis.line = element_line(color = "black", linewidth = .5),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        aspect.ratio = .5,
        legend.position = "right")

ggsave("figures/fig2.png", plot = p2, width = 6.5, height = 2.5, dpi = 300)

```

Figure 3: Energy use in reference & intervention scenarios
```{r}
# Electricity

# Create dataframe with total mwh for each scenario
df_sum("ref_kwh", ashp_ref_data1, weatherize_ref_data1, hpwh_ref_data1)
ref_mwh <- ref_kwh[, -1] / 1000
df_sum("intv_kwh", ashp_intv_data1, weatherize_intv_data1, hpwh_intv_data1)
intv_mwh <- intv_kwh[, -1] / 1000

mcs_stats_cumul("ref_mwh_stats", ref_mwh, lower_bound_out = .05, lower_bound_in = .25, upper_bound_in = .75, upper_bound_out = .95)
mcs_stats_cumul("intv_mwh_stats", intv_mwh, lower_bound_out = .05, lower_bound_in = .25, upper_bound_in = .75, upper_bound_out = .95)

# Convert year column to numeric
ref_mwh_stats$year <- as.numeric(ref_mwh_stats$year) 
intv_mwh_stats$year <- as.numeric(intv_mwh_stats$year) 

# Add an identifier column to each dataframe
ref_mwh_stats$Scenario <- "Reference Scenario"
intv_mwh_stats$Scenario <- "Intervention Scenario"

mwhplot <- bind_rows(ref_mwh_stats, intv_mwh_stats)

# mwh comparison plot
p_mwh <- ggplot(mwhplot, aes(x = year, y = median, color = Scenario, fill = Scenario)) +
  geom_line(size = .5) + 
  geom_ribbon(aes(ymin = lb1, ymax = ub1), alpha = 0.25, color = NA) +
  geom_ribbon(aes(ymin = lb2, ymax = ub2), alpha = 0.4, color = NA) +
  labs(title = "a",
       x = "Year",
       y = "Megawatt-hours") +
  scale_y_continuous(labels = comma, breaks = scales::breaks_extended(n = 6)) +
  scale_x_continuous(
    breaks = seq(scenario_start, scenario_end, by = 5),
    labels = seq(scenario_start, scenario_end, by = 5)) +
  theme_minimal() +
  scale_color_manual(values = c("Reference Scenario" = "deepskyblue4", "Intervention Scenario" = "palegreen4")) +
  scale_fill_manual(values = c("Reference Scenario" = "deepskyblue4", "Intervention Scenario" = "palegreen4")) +
  theme(text = element_text(size = 8, color = "black"),
        plot.title = element_text(face = "bold", size = 12, color = "black"),
        axis.text = element_text(size = 8, color = "black"),
        axis.title = element_text(size = 8, color = "black"),
        legend.text = element_text(size = 8, color = "black"),
        axis.ticks = element_line(color = "black", linewidth = .5),
        axis.line = element_line(color = "black", linewidth = .5),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        aspect.ratio = 1)

# Natural Gas

# Create dataframe with total mmbtu for each scenario
ref_mmbtu <- ashp_ref_data2[,-1] + weatherize_ref_data2[,-1] + hpwh_ref_data2[,-1]
ref_mmbtu <- ref_mmbtu / 10
intv_mmbtu <- ashp_intv_data2[,-1] + weatherize_intv_data2[,-1] + hpwh_intv_data2[,-1]
intv_mmbtu <- intv_mmbtu / 10

mcs_stats_cumul("ref_mmbtu_stats", ref_mmbtu, lower_bound_out = .05, lower_bound_in = .25, upper_bound_in = .75, upper_bound_out = .95)
mcs_stats_cumul("intv_mmbtu_stats", intv_mmbtu, lower_bound_out = .05, lower_bound_in = .25, upper_bound_in = .75, upper_bound_out = .95)

# Convert year column to numeric
ref_mmbtu_stats$year <- as.numeric(ref_mmbtu_stats$year) 
intv_mmbtu_stats$year <- as.numeric(intv_mmbtu_stats$year) 

# Add an identifier column to each dataframe
ref_mmbtu_stats$Scenario <- "Reference Scenario"
intv_mmbtu_stats$Scenario <- "Intervention Scenario"

mmbtuplot <- bind_rows(ref_mmbtu_stats, intv_mmbtu_stats)

# mmbtu comparison plot
p_mmbtu <- ggplot(mmbtuplot, aes(x = year, y = median, color = Scenario, fill = Scenario)) +
  geom_line(size = .5) + 
  geom_ribbon(aes(ymin = lb1, ymax = ub1), alpha = 0.25, color = NA) +
  geom_ribbon(aes(ymin = lb2, ymax = ub2), alpha = 0.4, color = NA) +
  labs(title = "b",
       x = "Year",
       y = "Million BTUs") +
  scale_y_continuous(labels = comma, breaks = scales::breaks_extended(n = 6)) +
  scale_x_continuous(
    breaks = seq(scenario_start, scenario_end, by = 5),
    labels = seq(scenario_start, scenario_end, by = 5)) +
  theme_minimal() +
  scale_color_manual(values = c("Reference Scenario" = "deepskyblue4", "Intervention Scenario" = "palegreen4")) +
  scale_fill_manual(values = c("Reference Scenario" = "deepskyblue4", "Intervention Scenario" = "palegreen4")) +
  theme(text = element_text(size = 8, color = "black"),
        plot.title = element_text(face = "bold", size = 12, color = "black"),
        axis.text = element_text(size = 8, color = "black"),
        axis.title = element_text(size = 8, color = "black"),
        legend.text = element_text(size = 8, color = "black"),
        axis.ticks = element_line(color = "black", linewidth = .5),
        axis.line = element_line(color = "black", linewidth = .5),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        aspect.ratio = 1)

p3 <- p_mwh + p_mmbtu + plot_layout(guides = 'collect')

ggsave("figures/fig3.png", plot = p3, width = 6.5, height = 2.5, dpi = 300)

```

Figure 4: GHG Mitigation
```{r}
# GHG mitigation histogram
cumul_sum1("ghg_cumul", ghg_mitigation)
mcs_stats_cumul("ghg_stats", ghg_mitigation, lower_bound_out = .05, lower_bound_in = .25, upper_bound_in = .75, upper_bound_out = .95)
total_ghg_mit <- as.data.frame(ghg_cumul[,(scenario_years + 1)]) 
ghg_lb1 <- ghg_stats[scenario_years,2]
ghg_lb2 <- ghg_stats[scenario_years,3] 
ghg_median <- ghg_stats[scenario_years,4]
ghg_ub2 <- ghg_stats[scenario_years,5]
ghg_ub1 <- ghg_stats[scenario_years,6]
ghg_bin <- (ghg_median - ghg_lb2)/3

p4 <- ggplot(total_ghg_mit, aes(x = total_ghg_mit[,1])) +
  geom_histogram(binwidth = ghg_bin, fill = "darkgrey", color = "black", alpha = 0.7) +
  geom_vline(aes(xintercept = ghg_median, color = "Median"), linetype = "solid", size = .75) + 
  geom_vline(aes(xintercept = ghg_lb1, color = "5%-95% Percentile Range"), linetype = "dotted", size = .75) +
  geom_vline(aes(xintercept = ghg_lb2, color = "25%-75% Percentile Range"), linetype = "dashed", size = .75) +
  geom_vline(aes(xintercept = ghg_ub2), color = "palegreen4", linetype = "dashed", size = .75) +
  geom_vline(aes(xintercept = ghg_ub1), color = "orangered4", linetype = "dotted", size = .75) +
  labs(title = NULL, x = "tCO2e", y = "Frequency") + 
  scale_x_continuous(labels = comma, breaks = scales::breaks_extended(n = 10)) +
  theme_minimal() + 
  theme(text = element_text(size = 8, color = "black"),
        plot.title = element_text(face = "bold", size = 12, color = "black"),
        axis.text = element_text(size = 8, color = "black"),
        axis.title = element_text(size = 8, color = "black"),
        legend.text = element_text(size = 8, color = "black"),
        axis.ticks = element_line(color = "black", size = .5),
        axis.line = element_line(color = "black", size = .5),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        aspect.ratio = .6,
        legend.position = "right",  
        legend.title = element_blank(),
        legend.key.height = unit(.75, "cm")) +
  scale_color_manual(name = NULL, 
                     values = c("Median" = "deepskyblue4",
                                "25%-75% Percentile Range" = "palegreen4",
                                "5%-95% Percentile Range" = "orangered4"),
                     breaks = c("Median", "25%-75% Percentile Range", "5%-95% Percentile Range"))

ggsave("figures/fig4.png", plot = p4, width = 6.5, height = 3, dpi = 300)

```

Figure 5: Capex and Opex
```{r}
# Capex & opex cashflow
quick_discount("capex3.5", "3.5_dr_out", cashflow_investment, dr = 3.5)
quick_discount("opex3.5", "3.5_dr_out", cashflow_opex, dr = 3.5)

mcs_stats_ann("capex3.5_stats", capex3.5, lower_bound_out = .05, lower_bound_in = .25, upper_bound_in = .75, upper_bound_out = .95)
mcs_stats_ann("opex3.5_stats", opex3.5, lower_bound_out = .05, lower_bound_in = .25, upper_bound_in = .75, upper_bound_out = .95)

# Convert year column to numeric
capex3.5_stats$year <- as.numeric(capex3.5_stats$year) 
opex3.5_stats$year <- as.numeric(opex3.5_stats$year) 

# Adjust cashflow to be in $1,000 USD
capex3.5_stats <- capex3.5_stats %>%
  mutate(across(-year, ~ . / 1000)) 

opex3.5_stats <- opex3.5_stats %>%
  mutate(across(-year, ~ . / 1000)) 

# capex plot
p_capex <- ggplot(capex3.5_stats, aes(x = year, y = median)) +
  geom_line(aes(group = 1), color = "deepskyblue4", size = .5) +   
  geom_ribbon(aes(ymin = lb1, ymax = ub1, group = 1), fill = "deepskyblue4", alpha = 0.25) + 
  geom_ribbon(aes(ymin = lb2, ymax = ub2, group = 1), fill = "deepskyblue4", alpha = 0.4) +  
  labs(title = "a",
       x = "Year",
       y = "Annual Capex\n(PV $1,000 USD)") +
  scale_y_continuous(labels = comma, breaks = scales::breaks_extended(n = 6)) +
  scale_x_continuous(
    breaks = seq(scenario_start, scenario_end, by = 10),
    labels = seq(scenario_start, scenario_end, by = 10)) +
  theme_minimal() +
  theme(text = element_text(size = 8, color = "black"),
        plot.title = element_text(face = "bold", size = 12, color = "black"),
        axis.text = element_text(size = 8, color = "black"),
        axis.title = element_text(size = 8, color = "black"),
        legend.text = element_text(size = 8, color = "black"),
        axis.ticks = element_line(color = "black", size = .5),
        axis.line = element_line(color = "black", size = .5),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        aspect.ratio = 1)

# opex plot
p_opex <- ggplot(opex3.5_stats, aes(x = year, y = median)) +
  geom_line(aes(group = 1), color = "palegreen4", size = .5) +   
  geom_ribbon(aes(ymin = lb1, ymax = ub1, group = 1), fill = "palegreen4", alpha = 0.25) + 
  geom_ribbon(aes(ymin = lb2, ymax = ub2, group = 1), fill = "palegreen4", alpha = 0.4) +  
  labs(title = "b",
       x = "Year",
       y = "Annual Opex\n(PV $1,000 USD)") +
  scale_y_continuous(labels = comma, breaks = scales::breaks_extended(n = 6)) +
  scale_x_continuous(
    breaks = seq(scenario_start, scenario_end, by = 10),
    labels = seq(scenario_start, scenario_end, by = 10)) +
  theme_minimal() +
  theme(text = element_text(size = 8, color = "black"),
        plot.title = element_text(face = "bold", size = 12, color = "black"),
        axis.text = element_text(size = 8, color = "black"),
        axis.title = element_text(size = 8, color = "black"),
        legend.text = element_text(size = 8, color = "black"),
        axis.ticks = element_line(color = "black", size = .5),
        axis.line = element_line(color = "black", size = .5),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        aspect.ratio = 1)

# Economic cashflow plot 

quick_discount("cashflow_econ3.5", "3.5_dr_out", cashflow_econ, dr = 3.5)
mcs_stats_cumul("cashflow_stats", cashflow_econ3.5, lower_bound_out = .05, lower_bound_in = .25, upper_bound_in = .75, upper_bound_out = .95)

# Convert year column to numeric
cashflow_stats$year <- as.numeric(cashflow_stats$year) 

# Adjust cashflow to be in $1,000 USD
cashflow_stats <- cashflow_stats %>%
  mutate(across(-year, ~ . / 1000)) 

# Plot
p_cashflow <- ggplot(cashflow_stats, aes(x = year, y = median)) +
  geom_line(aes(group = 1), color = "orangered4", size = .5) +   
  geom_ribbon(aes(ymin = lb1, ymax = ub1, group = 1), fill = "orangered4", alpha = 0.25) + 
  geom_ribbon(aes(ymin = lb2, ymax = ub2, group = 1), fill = "orangered4", alpha = 0.4) +  
  labs(title = "c",
       x = "Year",
       y = "Cumulative Cashflow\n(PV $1,000 USD)") +
  scale_y_continuous(labels = comma, breaks = scales::breaks_extended(n = 6)) +
  scale_x_continuous(
    breaks = seq(scenario_start, scenario_end, by = 10),
    labels = seq(scenario_start, scenario_end, by = 10)) +
  theme_minimal() +
  theme(text = element_text(size = 8, color = "black"),
        plot.title = element_text(face = "bold", size = 12, color = "black"),
        axis.text = element_text(size = 8, color = "black"),
        axis.title = element_text(size = 8, color = "black"),
        legend.text = element_text(size = 8, color = "black"),
        axis.ticks = element_line(color = "black", size = .5),
        axis.line = element_line(color = "black", size = .5),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        aspect.ratio = 1)

p5 <- p_capex + p_opex + p_cashflow

ggsave("figures/fig5.png", plot = p5, width = 6.5, height = 2, dpi = 300)

```

Figure 6: 6 panel CBA indicators
```{r}
# Calculates three seperate tables of NPV for private, economic and social costs, using the range of discount rates provided
dr_lb <- 1
dr_ub <- 8

cba_discountrange(dr_min = dr_lb, dr_max = dr_ub, annual_coben = coben_pv, scenario_lifetime = scenario_years)

# Calculates statistics for the Monte Carlo Simulation (lower bound, median, and upper bound)

mcs_cba_stats(lower_bound_out = .05, lower_bound_in = .25, upper_bound_in = .75, upper_bound_out = .95)

# need to convert discount rate column to numeric
npv_stats$dr <- as.numeric(npv_stats$dr)
sroi_stats$dr <- as.numeric(sroi_stats$dr) 
lcca_stats$dr <- as.numeric(lcca_stats$dr) 

# Adjust NPV to be in $1,000 USD
npv_stats <- npv_stats %>%
  mutate(across(-dr, ~ . / 1000)) 

# Produce each panel

cba_econ_plot("npv_econ_plot", npv_stats, c = "deepskyblue4", ylab = "NPV ($1,000 USD)\n ", xlab = expression("r"[e]), panel = "a")
cba_social_plot("npv_social_plot", npv_stats, c = "deepskyblue4", ylab = NULL, xlab = expression("r"[e]), panel = "b")
cba_econ_plot("sroi_econ_plot", sroi_stats, c = "palegreen4", ylab = "SROI (benefits:costs)\n ", xlab = expression("r"[e]), panel = "c")
cba_social_plot("sroi_social_plot", sroi_stats, c = "palegreen4", ylab = NULL, xlab = expression("r"[e]), panel = "d")
cba_econ_plot("lcca_econ_plot", lcca_stats, c = "orangered4", ylab = "LCCA (USD/tCO2e)\n ", xlab = expression(atop("r"[e], "\nEconomic Boundary")), panel = "e")
cba_social_plot("lcca_social_plot", lcca_stats, c = "orangered4", ylab = NULL, xlab = expression(atop("r"[e], "\nSocial Boundary")), panel = "f")

p6 <- npv_econ_plot + npv_social_plot + sroi_econ_plot + sroi_social_plot + lcca_econ_plot + lcca_social_plot + 
  plot_layout(ncol = 2, nrow = 3)

ggsave("figures/fig6.png", plot = p6, width = 6.5, height = 6.5, dpi = 300)

```

Sensitivity analysis
```{r}
# GHG mitigation
sens_ghg <- data.frame(p_count =  rowSums(intv_boundary_mgnl[,-1]),
                       ref_mwh = rowSums(ref_mwh),
                       ref_mmbtu = rowSums(ref_mmbtu),
                       ashp_savings = ashp_intv_factor[, 2],
                       weatherize_savings = weatherize_intv_factor[, 2],
                       hpwh_savings = hpwh_intv_factor[, 2],
                       ghg_mit = unname(ghg_mit))

inputs <- sens_ghg[, 1:(ncol(sens_ghg) - 1)]  # Model parameters (adjust column range)
output <- sens_ghg[, ncol(sens_ghg)]   # The final column is the emissions reduction result

# Load necessary package for Standardized Regression Coefficients (SRC)
library(boot)

# Fit a linear regression model using inputs to predict the output
lm_model <- lm(output ~ ., data = inputs)

# Compute standardized regression coefficients (SRC)
src_values <- coef(lm_model)[-1] * apply(inputs, 2, sd) / sd(output)

# Rank variables by absolute SRC value
ranked_src <- sort(abs(src_values), decreasing = TRUE)

# Print ranked variables
print(ranked_src)

# Convert SRC results into a data frame
src_df <- data.frame(Variable = names(ranked_src), SRC = ranked_src)

ggplot(src_df, aes(x = reorder(Variable, SRC), y = SRC)) +
  geom_segment(aes(xend = Variable, yend = 0), color = "gray") +  # Line from y = 0 to y = SRC
  geom_point(size = 4, color = "blue") +  # Point at the end of the line
  coord_flip() +  # Flip to horizontal layout
  labs(title = "Variable Importance (SRC)", x = "Variable", y = "SRC Value") +
  theme_minimal()


```

Results calcs
```{r}
# MWh savings

mwh_savings <- ref_mwh - intv_mwh
mcs_stats_cumul("mwhsavings_stats", mwh_savings, lower_bound_out = .05, lower_bound_in = .25, upper_bound_in = .75, upper_bound_out = .95)
mwhsavings_stats[24,1:6]

# MMBTU savings

mmbtu_savings <- ref_mmbtu - intv_mmbtu
mcs_stats_cumul("mmbtusavings_stats", mmbtu_savings, lower_bound_out = .05, lower_bound_in = .25, upper_bound_in = .75, upper_bound_out = .95)
mmbtusavings_stats[24,1:6]

# Upstream GHG emissions
ghg_upstream <- (ashp_intv_ghg_upstream[, -1] + weatherize_intv_ghg_upstream[, -1] + hpwh_intv_ghg_upstream[, -1])/1000
mcs_stats_cumul("ghg_upstreamstats", ghg_upstream, lower_bound_out = .05, lower_bound_in = .25, upper_bound_in = .75, upper_bound_out = .95)
ghg_upstreamstats[24,1:6]

# Scope 1 & 2 GHG emissions
ashp_ref_ghgsum <- ashp_ref_ghg_natgas[, -1] + ashp_ref_ghg_elec[, -1]
ashp_intv_ghgsum <- ashp_intv_ghg_natgas[, -1] + ashp_intv_ghg_elec[, -1]
weatherize_ref_ghgsum <- weatherize_ref_ghg_natgas[, -1] + weatherize_ref_ghg_elec[, -1]
weatherize_intv_ghgsum <- weatherize_intv_ghg_natgas[, -1] + weatherize_intv_ghg_elec[, -1]
hpwh_ref_ghgsum <- hpwh_ref_ghg_natgas[, -1] + hpwh_ref_ghg_elec[, -1]
hpwh_intv_ghgsum <- hpwh_intv_ghg_natgas[, -1] + hpwh_intv_ghg_elec[, -1]

ref_ghg_s1n2total <- ashp_ref_ghgsum + weatherize_ref_ghgsum + hpwh_ref_ghgsum
intv_ghg_s1n2total <- ashp_intv_ghgsum + weatherize_intv_ghgsum + hpwh_intv_ghgsum

ghg_scope1n2 <- (ref_ghg_s1n2total - intv_ghg_s1n2total)/1000
mcs_stats_cumul("ghg_scope1n2stats", ghg_scope1n2, lower_bound_out = .05, lower_bound_in = .25, upper_bound_in = .75, upper_bound_out = .95)
ghg_scope1n2stats[24,1:6]

# cashflow 
cashflow_stats[24,1:6]

```

Excel Exports
```{r}
ashp_outputlist <- (list("ashp_boundary_mgnl" = ashp_boundary_mgnl,
                         "ashp_ref_ann_data1" = ashp_ref_ann_data1,
                         "ashp_ref_ann_data2" = ashp_ref_ann_data2,
                         "ashp_ref_data1" = ashp_ref_data1,
                         "ashp_ref_data2" = ashp_ref_data2,
                         "ashp_ref_ghg_elec" = ashp_ref_ghg_elec,
                         "ashp_ref_ghg_natgas" = ashp_ref_ghg_natgas,
                         "ashp_ref_ghgsum" = ashp_ref_ghgsum,
                         "ashp_ref_ghg_upstream" = ashp_ref_ghg_upstream,
                         "ashp_ref_capex1" = ashp_ref_capex1,
                         "ashp_ref_opex1" = ashp_ref_opex1,
                         "ashp_ref_opex2" = ashp_ref_opex2,
                         "ashp_ref_capexsum" = ashp_ref_capexsum,
                         "ashp_ref_opexsum" = ashp_ref_opexsum,
                         "ashp_intv_ann_data1" = ashp_intv_ann_data1,
                         "ashp_intv_ann_data2" = ashp_intv_ann_data2,
                         "ashp_intv_factor" = ashp_intv_factor, #new
                         "ashp_intv_data1" = ashp_intv_data1,
                         "ashp_intv_data2" = ashp_intv_data2,
                         "ashp_intv_ghg_elec" = ashp_intv_ghg_elec,
                         "ashp_intv_ghg_natgas" = ashp_intv_ghg_natgas,
                         "ashp_intv_ghgsum" = ashp_intv_ghgsum,
                         "ashp_intv_ghg_upstream" = ashp_intv_ghg_upstream,
                         "ashp_intv_capex1" = ashp_intv_capex1,
                         "ashp_intv_opex1" = ashp_intv_opex1,
                         "ashp_intv_opex2" = ashp_intv_opex2,
                         "ashp_intv_capexsum" = ashp_intv_capexsum,
                         "ashp_intv_opexsum" = ashp_intv_opexsum)
)

weatherize_outputlist <- (list("weatherize_boundary_mgnl" = weatherize_boundary_mgnl,
                         "weatherize_ref_ann_data1" = weatherize_ref_ann_data1,
                         "weatherize_ref_ann_data2" = weatherize_ref_ann_data2,
                         "weatherize_ref_data1" = weatherize_ref_data1,
                         "weatherize_ref_data2" = weatherize_ref_data2,
                         "weatherize_ref_ghg_elec" = weatherize_ref_ghg_elec,
                         "weatherize_ref_ghg_natgas" = weatherize_ref_ghg_natgas,
                         "weatherize_ref_ghgsum" = weatherize_ref_ghgsum,
                         "weatherize_ref_ghg_upstream" = weatherize_ref_ghg_upstream,
                         "weatherize_ref_capex1" = weatherize_ref_capex1,
                         "weatherize_ref_opex1" = weatherize_ref_opex1,
                         "weatherize_ref_opex2" = weatherize_ref_opex2,
                         "weatherize_ref_capexsum" = weatherize_ref_capexsum,
                         "weatherize_ref_opexsum" = weatherize_ref_opexsum,
                         "weatherize_intv_ann_data1" = weatherize_intv_ann_data1,
                         "weatherize_intv_ann_data2" = weatherize_intv_ann_data2,
                         "weatherize_intv_data1" = weatherize_intv_data1,
                         "weatherize_intv_data2" = weatherize_intv_data2,
                         "weatherize_intv_ghg_elec" = weatherize_intv_ghg_elec,
                         "weatherize_intv_ghg_natgas" = weatherize_intv_ghg_natgas,
                         "weatherize_intv_ghgsum" = weatherize_intv_ghgsum,
                         "weatherize_intv_ghg_upstream" = weatherize_intv_ghg_upstream,
                         "weatherize_intv_capex1" = weatherize_intv_capex1,
                         "weatherize_intv_opex1" = weatherize_intv_opex1,
                         "weatherize_intv_opex2" = weatherize_intv_opex2,
                         "weatherize_intv_capexsum" = weatherize_intv_capexsum,
                         "weatherize_intv_opexsum" = weatherize_intv_opexsum)
)

hpwh_outputlist <- (list("hpwh_boundary_mgnl" = hpwh_boundary_mgnl,
                         "hpwh_ref_ann_data1" = hpwh_ref_ann_data1,
                         "hpwh_ref_ann_data2" = hpwh_ref_ann_data2,
                         "hpwh_ref_data1" = hpwh_ref_data1,
                         "hpwh_ref_data2" = hpwh_ref_data2,
                         "hpwh_ref_ghg_elec" = hpwh_ref_ghg_elec,
                         "hpwh_ref_ghg_natgas" = hpwh_ref_ghg_natgas,
                         "hpwh_ref_ghgsum" = hpwh_ref_ghgsum,
                         "hpwh_ref_ghg_upstream" = hpwh_ref_ghg_upstream,
                         "hpwh_ref_capex1" = hpwh_ref_capex1,
                         "hpwh_ref_opex1" = hpwh_ref_opex1,
                         "hpwh_ref_opex2" = hpwh_ref_opex2,
                         "hpwh_ref_capexsum" = hpwh_ref_capexsum,
                         "hpwh_ref_opexsum" = hpwh_ref_opexsum,
                         "hpwh_intv_ann_data1" = hpwh_intv_ann_data1,
                         "hpwh_intv_ann_data2" = hpwh_intv_ann_data2,
                         "hpwh_intv_data1" = hpwh_intv_data1,
                         "hpwh_intv_data2" = hpwh_intv_data2,
                         "hpwh_intv_ghg_elec" = hpwh_intv_ghg_elec,
                         "hpwh_intv_ghg_natgas" = hpwh_intv_ghg_natgas,
                         "hpwh_intv_ghgsum" = hpwh_intv_ghgsum,
                         "hpwh_intv_ghg_upstream" = hpwh_intv_ghg_upstream,
                         "hpwh_intv_capex1" = hpwh_intv_capex1,
                         "hpwh_intv_opex1" = hpwh_intv_opex1,
                         "hpwh_intv_opex2" = hpwh_intv_opex2,
                         "hpwh_intv_capexsum" = hpwh_intv_capexsum,
                         "hpwh_intv_opexsum" = hpwh_intv_opexsum)
)

summary_outputlist <- (list("cashflow_investment" = cashflow_investment,
                         "cashflow_opex" = cashflow_opex,
                         "cashflow_private" = cashflow_private,
                         "cashflow_econ" = cashflow_econ,
                         "cashflow_social" = cashflow_social,
                         "coben1_sim" = coben1_sim,
                         "coben1_value" = coben1_value,
                         "ghg_mitigation" = ghg_mitigation,
                         "intv_boundary_mgnl" = intv_boundary_mgnl,
                         "intv_capexsum" = intv_capexsum,
                         "intv_costs_econ" = intv_costs_econ,
                         "intv_ghgsum" = intv_ghgsum,
                         "intv_opexsum" = intv_opexsum,
                         "ref_boundary_mgnl" = ref_boundary_mgnl,
                         "ref_capexsum" = ref_capexsum,
                         "ref_costs_econ" = ref_costs_econ,
                         "ref_ghgsum" = ref_ghgsum,
                         "ref_opexsum" = ref_opexsum)
)

write_xlsx(ashp_outputlist, path = "ashp_output.xlsx")
write_xlsx(weatherize_outputlist, path = "weatherize_output.xlsx")
write_xlsx(hpwh_outputlist, path = "hpwh_output.xlsx")
write_xlsx(summary_outputlist, path = "summary_output.xlsx")

```