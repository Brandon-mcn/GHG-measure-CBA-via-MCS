---
title: Monte Carlo Simulation for City of Flagstaff Home Weatherization and Energy Rebate Program
author: Brandon McNamara
project: Dissertation chapter 3
date: March 11, 2025
---

Package Install & Load
```{r setup}
if (!require("dplyr")) install.packages("dplyr")
library(dplyr)
if (!require("readxl")) install.packages("readxl")
library(readxl)
if (!require("writexl")) install.packages("writexl")
library(writexl)
if (!require("ggplot2")) install.packages("ggplot2")
library(ggplot2)
if (!require("scales")) install.packages("scales")
library(scales)
if (!require("data.table")) install.packages("data.table")
library(data.table)
```

Set up global variables
```{r}
# Define the following global variables to be called by parameter functions
run_count <- 1000
scenario_start <- 2026
intv_years <- 10 # The number of years the intervention will be implemented
intv_lifetime <- 15 # The number of years the intervention generates benefits, generally the expected lifetime of equipment
scenario_end  <- scenario_start + intv_years + intv_lifetime - 1
scenario_years <- scenario_end - scenario_start + 1
output_headers <- scenario_start:scenario_end
```

Initiate helper functions
```{r}
source("parameter_functions.r")
```

Create CO2e Emission Factor Library
```{r}
EFL_co2e("ar6")
write_xlsx(EFL, path = "EFLco2e.xlsx")
```

Emission Factor Simulations
```{r}
# Electricity emission factor
scenario_MCS("ef_sim_electricity", sheet_name = "electricity_ef", units = "kgco2e/kWh")

# Supply Chain emission factor
continuous_uniform2("ef_sim_appliances_upstream", minvalue = 0.079, maxvalue = 0.161, units = "kgco2e/USD")
continuous_uniform2("ef_sim_weatherize_upstream", minvalue = 0.082, maxvalue = 0.208, units = "kgco2e/USD")

```

Boundary Simulations
```{r}
# Reference boundary represents zero energy efficiency upgrades in each year
static_value("ref_boundary_mgnl", 0, units = "project count")

# Intervention boundary is modeled as a random value between 120 and 160.
# The program is assumed to have funding for 10 years. After that, no more homes are funded. 
discrete_uniform3("intv_boundary_mgnl", minvalue = 120, maxvalue = 160, nyears = intv_years, value2 = 0, units = "project count")

# Project types are randomly assigned for the intervention boundary, with three new dataframes for each project type.
assign_projecttype(intv_boundary_mgnl)

```

Air source heat pumps (ASHP): Activity data, cost, and GHG simulations
```{r}
# Simulate annual electricity consumption for space heating and cooling. Each home in the boundary is simulated individually. The intervention factor is the % energy savings, also simulated for each home in the boundary. 
calc_ad1("ashp_ref_ann_data1",
         "ashp_intv_ann_data1",
         ashp_boundary_mgnl, 
         ref_pdf = rnorm,
         ref_params = list(mean = 4161, sd = 233), # Reference electricity consumption is modeled with a normal distribution
         intv_pdf = runif, 
         intv_params = list(min = 0.31, max = 0.47), # Intervention factor, % savings, is modeled with a uniform distribution  
         units = "kWh")

# Calculate cumulative activity data
cumul_sum2("ashp_ref_data1", ashp_ref_ann_data1)
cumul_sum2("ashp_intv_data1", ashp_intv_ann_data1)

# Simulate annual natural gas consumption for space heating. Each home in the boundary is simulated individually. The intervention factor is the % energy savings, also simulated for each home in the boundary. 
calc_ad1("ashp_ref_ann_data2",
         "ashp_intv_ann_data2",
         ashp_boundary_mgnl, 
         ref_pdf = rnorm,
         ref_params = list(mean = 603, sd = 11.3), # Reference natural gas consumption is modeled with a normal distribution
         intv_pdf = runif, 
         intv_params = list(min = 0.31, max = 0.47), # Intervention factor, % savings,is modeled with a uniform distribution  
         units = "therms")

# Calculate cumulative activity data
cumul_sum2("ashp_ref_data2", ashp_ref_ann_data2)
cumul_sum2("ashp_intv_data2", ashp_intv_ann_data2)

# ASHP Capex is calculated by simulating the installation costs for each home
calculate_capex("ashp_ref_capex1", "ashp_intv_capex1", ref_boundary_mgnl, ashp_boundary_mgnl, capex_min = 2100, capex_max = 6000, units = "USD")

# Sum total Capex
ashp_ref_sumcapex <- ashp_ref_capex1[,-1]
ashp_intv_sumcapex <- ashp_intv_capex1[,-1]

# ASHP Opex is calculated for electricity and natural gas separately, based on current energy prices
calculate_opex("ashp_ref_opex1", "ashp_intv_opex1", ashp_ref_data1, ashp_intv_data1, opex = 0.1542, units = "USD")
calculate_opex("ashp_ref_opex2", "ashp_intv_opex2", ashp_ref_data2, ashp_intv_data2, opex = 0.3434, units = "therms")

# Sum total opex
ashp_ref_sumopex <- ashp_ref_opex1[,-1] + ashp_ref_opex2[,-1]
ashp_intv_sumopex <- ashp_intv_opex1[,-1] + ashp_intv_opex2[,-1]

# Calculate scope 1 natural gas emissions 
ghg_conversion1("ashp_ref_ghg_natgas",
                "ashp_intv_ghg_natgas",
                ashp_ref_data2,
                ashp_intv_data2,
                fltr.ef_activeyear = 2024, 
                fltr.service_type = "natural gas", 
                fltr.emission_category = "stationary", 
                fltr.emission_scope = "scope 1",
                fltr.service_subcategory1 = "", 
                fltr.service_subcategory2 = "", 
                fltr.country = "global", 
                fltr.subregion = "")

# Calculate scope 2 electricity ghg emissions based on a simulation of grid emissions intensity
ghg_conversion2("ashp_ref_ghg_elec", "ashp_intv_ghg_elec", ef_sim_electricity, ashp_ref_data1, ashp_intv_data1)

# Calculate scope 3 supply chain ghg emissions based on a simulation of the upstream spend-based emission factor
ghg_conversion3("ashp_ref_ghg_upstream", "ashp_intv_ghg_upstream", ef_sim_appliances_upstream, ashp_ref_capex1, ashp_intv_capex1)

# Calculate total ashp GHG emissions
ashp_ref_ghg_total <- ashp_ref_ghg_natgas[, -1] + ashp_ref_ghg_elec[, -1] + ashp_ref_ghg_upstream[, -1]
ashp_intv_ghg_total <- ashp_intv_ghg_natgas[, -1] + ashp_intv_ghg_elec[, -1] + ashp_intv_ghg_upstream[, -1]

```

Weatherization: Activity data, cost, and GHG simulations
```{r}
# Simulate annual electricity consumption for space heating and cooling. Each home in the boundary is simulated individually. The intervention factor is the % energy savings, also simulated for each home in the boundary. 
calc_ad1("weatherize_ref_ann_data1",
         "weatherize_intv_ann_data1",
         weatherize_boundary_mgnl, 
         ref_pdf = rnorm,
         ref_params = list(mean = 4161, sd = 233), # Reference electricity consumption is modeled with a normal distribution
         intv_pdf = runif, 
         intv_params = list(min = 0.10, max = 0.20), # Intervention factor, % savings, is modeled with a uniform distribution  
         units = "kWh")

# Calculate cumulative activity data
cumul_sum2("weatherize_ref_data1", weatherize_ref_ann_data1)
cumul_sum2("weatherize_intv_data1", weatherize_intv_ann_data1)

# Simulate annual natural gas consumption for space heating. Each home in the boundary is simulated individually. The intervention factor is the % energy savings, also simulated for each home in the boundary. 
calc_ad1("weatherize_ref_ann_data2",
         "weatherize_intv_ann_data2",
         weatherize_boundary_mgnl, 
         ref_pdf = rnorm,
         ref_params = list(mean = 603, sd = 11.3), # Reference natural gas consumption is modeled with a normal distribution
         intv_pdf = runif, 
         intv_params = list(min = 0.10, max = 0.20), # Intervention factor, % savings,is modeled with a uniform distribution  
         units = "therms")

# Calculate cumulative activity data
cumul_sum2("weatherize_ref_data2", weatherize_ref_ann_data2)
cumul_sum2("weatherize_intv_data2", weatherize_intv_ann_data2)

# Weatherization Capex is calculated by simulating the installation costs for each home
calculate_capex("weatherize_ref_capex1", "weatherize_intv_capex1", ref_boundary_mgnl, weatherize_boundary_mgnl, capex_min = 1879, capex_max = 2962, units = "USD")

# Sum total Capex
weatherize_ref_sumcapex <- weatherize_ref_capex1[,-1]
weatherize_intv_sumcapex <- weatherize_intv_capex1[,-1]

# Weatherization Opex is calculated for electricity and natural gas separately, based on current energy prices
calculate_opex("weatherize_ref_opex1", "weatherize_intv_opex1", weatherize_ref_data1, weatherize_intv_data1, opex = 0.1542, units = "USD")
calculate_opex("weatherize_ref_opex2", "weatherize_intv_opex2", weatherize_ref_data2, weatherize_intv_data2, opex = 0.3434, units = "therms")

# Sum total Opex
weatherize_ref_sumopex <- weatherize_ref_opex1[,-1] + weatherize_ref_opex2[,-1]
weatherize_intv_sumopex <- weatherize_intv_opex1[,-1] + weatherize_intv_opex2[,-1]

# Calculate scope 1 natural gas emissions 
ghg_conversion1("weatherize_ref_ghg_natgas",
                "weatherize_intv_ghg_natgas",
                weatherize_ref_data2,
                weatherize_intv_data2,
                fltr.ef_activeyear = 2024, 
                fltr.service_type = "natural gas", 
                fltr.emission_category = "stationary", 
                fltr.emission_scope = "scope 1",
                fltr.service_subcategory1 = "", 
                fltr.service_subcategory2 = "", 
                fltr.country = "global", 
                fltr.subregion = "")

# Calculate scope 2 electricity ghg emissions based on a simulation of grid emissions intensity
ghg_conversion2("weatherize_ref_ghg_elec", "weatherize_intv_ghg_elec", ef_sim_electricity, weatherize_ref_data1, weatherize_intv_data1)

# Calculate scope 3 supply chain ghg emissions based on a simulation of the upstream spend-based emission factor
ghg_conversion3("weatherize_ref_ghg_upstream", "weatherize_intv_ghg_upstream", ef_sim_weatherize_upstream, weatherize_ref_capex1, weatherize_intv_capex1)

# Calculate total weatherize GHG emissions
weatherize_ref_ghg_total <- weatherize_ref_ghg_natgas[, -1] + weatherize_ref_ghg_elec[, -1] + weatherize_ref_ghg_upstream[, -1]
weatherize_intv_ghg_total <- weatherize_intv_ghg_natgas[, -1] + weatherize_intv_ghg_elec[, -1] + weatherize_intv_ghg_upstream[, -1]

```

Heat Pump Water Heater (HPWH): Activity data, cost, and GHG simulations
```{r}
# Simulate annual electricity consumption for water heating. Each home in the boundary is simulated individually. The intervention factor is the % energy savings, also simulated for each home in the boundary. 
calc_ad1("hpwh_ref_ann_data1",
         "hpwh_intv_ann_data1",
         hpwh_boundary_mgnl, 
         ref_pdf = rnorm,
         ref_params = list(mean = 2969, sd = 108.1), # Reference electricity consumption is modeled with a normal distribution
         intv_pdf = runif, 
         intv_params = list(min = 0.30, max = 0.70), # Intervention factor, % savings, is modeled with a uniform distribution  
         units = "kWh")

# Calculate cumulative activity data
cumul_sum2("hpwh_ref_data1", hpwh_ref_ann_data1)
cumul_sum2("hpwh_intv_data1", hpwh_intv_ann_data1)

# Simulate annual natural gas consumption for space heating. Each home in the boundary is simulated individually. The intervention factor is the % energy savings, also simulated for each home in the boundary. 
calc_ad1("hpwh_ref_ann_data2",
         "hpwh_intv_ann_data2",
         hpwh_boundary_mgnl, 
         ref_pdf = rnorm,
         ref_params = list(mean = 237, sd = 4), # Reference natural gas consumption is modeled with a normal distribution
         intv_pdf = runif, 
         intv_params = list(min = 0.30, max = 0.70), # Intervention factor, % savings,is modeled with a uniform distribution  
         units = "therms")

# Calculate cumulative activity data
cumul_sum2("hpwh_ref_data2", hpwh_ref_ann_data2)
cumul_sum2("hpwh_intv_data2", hpwh_intv_ann_data2)

# HPWH Capex is calculated by simulating the installation costs for each home
calculate_capex("hpwh_ref_capex1", "hpwh_intv_capex1", ref_boundary_mgnl, hpwh_boundary_mgnl, capex_min = 1300, capex_max = 2900, units = "USD")

# Sum total Capex
hpwh_ref_sumcapex <- hpwh_ref_capex1[,-1]
hpwh_intv_sumcapex <- hpwh_intv_capex1[,-1]

# HPWH Opex is calculated for electricity and natural gas separately, based on current energy prices
calculate_opex("hpwh_ref_opex1", "hpwh_intv_opex1", hpwh_ref_data1, hpwh_intv_data1, opex = 0.1542, units = "USD")
calculate_opex("hpwh_ref_opex2", "hpwh_intv_opex2", hpwh_ref_data2, hpwh_intv_data2, opex = 0.3434, units = "therms")

# Sum total Opex
hpwh_ref_sumopex <- hpwh_ref_opex1[,-1] + hpwh_ref_opex2[,-1]
hpwh_intv_sumopex <- hpwh_intv_opex1[,-1] + hpwh_intv_opex2[,-1]

# Calculate scope 1 natural gas emissions 
ghg_conversion1("hpwh_ref_ghg_natgas",
                "hpwh_intv_ghg_natgas",
                hpwh_ref_data2,
                hpwh_intv_data2,
                fltr.ef_activeyear = 2024, 
                fltr.service_type = "natural gas", 
                fltr.emission_category = "stationary", 
                fltr.emission_scope = "scope 1",
                fltr.service_subcategory1 = "", 
                fltr.service_subcategory2 = "", 
                fltr.country = "global", 
                fltr.subregion = "")

# Calculate scope 2 electricity ghg emissions based on a simulation of grid emissions intensity
ghg_conversion2("hpwh_ref_ghg_elec", "hpwh_intv_ghg_elec", ef_sim_electricity, hpwh_ref_data1, hpwh_intv_data1)

# Calculate scope 3 supply chain ghg emissions based on a simulation of the upstream spend-based emission factor
ghg_conversion3("hpwh_ref_ghg_upstream", "hpwh_intv_ghg_upstream", ef_sim_appliances_upstream, hpwh_ref_capex1, hpwh_intv_capex1)

# Calculate total HPWH GHG emissions
hpwh_ref_ghg_total <- hpwh_ref_ghg_natgas[, -1] + hpwh_ref_ghg_elec[, -1] + hpwh_ref_ghg_upstream[, -1]
hpwh_intv_ghg_total <- hpwh_intv_ghg_natgas[, -1] + hpwh_intv_ghg_elec[, -1] + hpwh_intv_ghg_upstream[, -1]

```

Calculate GHG Mitigation
```{r}
# calculate total reference GHG emissions
ref_ghg_total <- (ashp_ref_ghg_total + weatherize_ref_ghg_total + hpwh_ref_ghg_total)/1000
ref_ghg_total <- ref_ghg_total %>%
    mutate(unit = "mtco2e") %>%  
    select(unit, everything())  

# calculate total intervention GHG emissions
intv_ghg_total <- (ashp_intv_ghg_total + weatherize_intv_ghg_total + hpwh_intv_ghg_total)/1000
intv_ghg_total <- intv_ghg_total %>%
    mutate(unit = "mtco2e") %>%  #
    select(unit, everything())  

# Calculate GHG mitigation
ghg_mitigation <- ref_ghg_total[, -1] - intv_ghg_total[, -1]
ghg_mitigation <- ghg_mitigation %>%
    mutate(unit = "mtco2e") %>%  
    select(unit, everything())  

```

Calculate total costs and co-benefits
```{r}
# Calculate total reference scenario costs
ref_opex_total <- ashp_ref_sumopex + weatherize_ref_sumopex + hpwh_ref_sumopex
ref_capex_total <- ashp_ref_sumcapex + weatherize_ref_sumcapex + hpwh_ref_sumcapex
ref_costs_econ <- ref_opex_total + ref_capex_total

# Calculate total intervention scenario costs
intv_opex_total <- ashp_intv_sumopex + weatherize_intv_sumopex + hpwh_intv_sumopex
intv_capex_total <- ashp_intv_sumcapex + weatherize_intv_sumcapex + hpwh_intv_sumcapex
intv_costs_econ <- intv_opex_total + intv_capex_total

# Social cost of carbon (SCC) is modeled as a normal distribution. It's modeled as an avoided cost, so a positive value is used. 
# mean = $185 sd = $85.7
# The selected value for each simulation is applied consistently over the scenario lifetime.
normal_PDF("coben1_sim", 185, 85.7, units = "USD/mtco2e")

# The function above leads to negative values for the social cost of carbon. In practice, this does not make sense. So negative values are converted to 0 below
coben1_sim[coben1_sim < 0] <- 0

# Calculate social value from Parameter 1 co-benefits 

coben1_value <- ghg_mitigation[, -1] * coben1_sim[, -1]
coben1_value <- coben1_value %>%
    mutate(unit = "social value of avoided carbon (USD)") %>%  
    select(unit, everything()) 
coben_value_trim <- coben1_value[, -1]

# Calculate cashflow
cashflow_investment <- intv_capex_total - ref_capex_total # Assuming capex costs = investment costs
cashflow_opex <- intv_opex_total - ref_opex_total
cashflow_econ <- intv_costs_econ - ref_costs_econ
cashflow_social <- cashflow_econ + coben_value_trim
cashflow_private <- cashflow_econ # This is a space holder for now. This could use the average rebate coverage to calculate cost to city of Flag

```

Excel Exports
```{r}
ashp_outputlist <- (list("ashp_boundary_mgnl" = ashp_boundary_mgnl,
                         "ashp_ref_ann_data1" = ashp_ref_ann_data1,
                         "ashp_ref_ann_data2" = ashp_ref_ann_data2,
                         "ashp_ref_data1" = ashp_ref_data1,
                         "ashp_ref_data2" = ashp_ref_data2,
                         "ashp_ref_ghg_elec" = ashp_ref_ghg_elec,
                         "ashp_ref_ghg_natgas" = ashp_ref_ghg_natgas,
                         "ashp_ref_ghg_total" = ashp_ref_ghg_total,
                         "ashp_ref_ghg_upstream" = ashp_ref_ghg_upstream,
                         "ashp_ref_capex1" = ashp_ref_capex1,
                         "ashp_ref_opex1" = ashp_ref_opex1,
                         "ashp_ref_opex2" = ashp_ref_opex2,
                         "ashp_ref_sumcapex" = ashp_ref_sumcapex,
                         "ashp_ref_sumopex" = ashp_ref_sumopex,
                         "ashp_intv_ann_data1" = ashp_intv_ann_data1,
                         "ashp_intv_ann_data2" = ashp_intv_ann_data2,
                         "ashp_intv_data1" = ashp_intv_data1,
                         "ashp_intv_data2" = ashp_intv_data2,
                         "ashp_intv_ghg_elec" = ashp_intv_ghg_elec,
                         "ashp_intv_ghg_natgas" = ashp_intv_ghg_natgas,
                         "ashp_intv_ghg_total" = ashp_intv_ghg_total,
                         "ashp_intv_ghg_upstream" = ashp_intv_ghg_upstream,
                         "ashp_intv_capex1" = ashp_intv_capex1,
                         "ashp_intv_opex1" = ashp_intv_opex1,
                         "ashp_intv_opex2" = ashp_intv_opex2,
                         "ashp_intv_sumcapex" = ashp_intv_sumcapex,
                         "ashp_intv_sumopex" = ashp_intv_sumopex)
)

weatherize_outputlist <- (list("weatherize_boundary_mgnl" = weatherize_boundary_mgnl,
                         "weatherize_ref_ann_data1" = weatherize_ref_ann_data1,
                         "weatherize_ref_ann_data2" = weatherize_ref_ann_data2,
                         "weatherize_ref_data1" = weatherize_ref_data1,
                         "weatherize_ref_data2" = weatherize_ref_data2,
                         "weatherize_ref_ghg_elec" = weatherize_ref_ghg_elec,
                         "weatherize_ref_ghg_natgas" = weatherize_ref_ghg_natgas,
                         "weatherize_ref_ghg_total" = weatherize_ref_ghg_total,
                         "weatherize_ref_ghg_upstream" = weatherize_ref_ghg_upstream,
                         "weatherize_ref_capex1" = weatherize_ref_capex1,
                         "weatherize_ref_opex1" = weatherize_ref_opex1,
                         "weatherize_ref_opex2" = weatherize_ref_opex2,
                         "weatherize_ref_sumcapex" = weatherize_ref_sumcapex,
                         "weatherize_ref_sumopex" = weatherize_ref_sumopex,
                         "weatherize_intv_ann_data1" = weatherize_intv_ann_data1,
                         "weatherize_intv_ann_data2" = weatherize_intv_ann_data2,
                         "weatherize_intv_data1" = weatherize_intv_data1,
                         "weatherize_intv_data2" = weatherize_intv_data2,
                         "weatherize_intv_ghg_elec" = weatherize_intv_ghg_elec,
                         "weatherize_intv_ghg_natgas" = weatherize_intv_ghg_natgas,
                         "weatherize_intv_ghg_total" = weatherize_intv_ghg_total,
                         "weatherize_intv_ghg_upstream" = weatherize_intv_ghg_upstream,
                         "weatherize_intv_capex1" = weatherize_intv_capex1,
                         "weatherize_intv_opex1" = weatherize_intv_opex1,
                         "weatherize_intv_opex2" = weatherize_intv_opex2,
                         "weatherize_intv_sumcapex" = weatherize_intv_sumcapex,
                         "weatherize_intv_sumopex" = weatherize_intv_sumopex)
)

hpwh_outputlist <- (list("hpwh_boundary_mgnl" = hpwh_boundary_mgnl,
                         "hpwh_ref_ann_data1" = hpwh_ref_ann_data1,
                         "hpwh_ref_ann_data2" = hpwh_ref_ann_data2,
                         "hpwh_ref_data1" = hpwh_ref_data1,
                         "hpwh_ref_data2" = hpwh_ref_data2,
                         "hpwh_ref_ghg_elec" = hpwh_ref_ghg_elec,
                         "hpwh_ref_ghg_natgas" = hpwh_ref_ghg_natgas,
                         "hpwh_ref_ghg_total" = hpwh_ref_ghg_total,
                         "hpwh_ref_ghg_upstream" = hpwh_ref_ghg_upstream,
                         "hpwh_ref_capex1" = hpwh_ref_capex1,
                         "hpwh_ref_opex1" = hpwh_ref_opex1,
                         "hpwh_ref_opex2" = hpwh_ref_opex2,
                         "hpwh_ref_sumcapex" = hpwh_ref_sumcapex,
                         "hpwh_ref_sumopex" = hpwh_ref_sumopex,
                         "hpwh_intv_ann_data1" = hpwh_intv_ann_data1,
                         "hpwh_intv_ann_data2" = hpwh_intv_ann_data2,
                         "hpwh_intv_data1" = hpwh_intv_data1,
                         "hpwh_intv_data2" = hpwh_intv_data2,
                         "hpwh_intv_ghg_elec" = hpwh_intv_ghg_elec,
                         "hpwh_intv_ghg_natgas" = hpwh_intv_ghg_natgas,
                         "hpwh_intv_ghg_total" = hpwh_intv_ghg_total,
                         "hpwh_intv_ghg_upstream" = hpwh_intv_ghg_upstream,
                         "hpwh_intv_capex1" = hpwh_intv_capex1,
                         "hpwh_intv_opex1" = hpwh_intv_opex1,
                         "hpwh_intv_opex2" = hpwh_intv_opex2,
                         "hpwh_intv_sumcapex" = hpwh_intv_sumcapex,
                         "hpwh_intv_sumopex" = hpwh_intv_sumopex)
)

summary_outputlist <- (list("cashflow_investment" = cashflow_investment,
                         "cashflow_opex" = cashflow_opex,
                         "cashflow_private" = cashflow_private,
                         "cashflow_econ" = cashflow_econ,
                         "cashflow_social" = cashflow_social,
                         "coben1_sim" = coben1_sim,
                         "coben1_value" = coben1_value,
                         "ghg_mitigation" = ghg_mitigation,
                         "intv_boundary_mgnl" = intv_boundary_mgnl,
                         "intv_capex_total" = intv_capex_total,
                         "intv_costs_econ" = intv_costs_econ,
                         "intv_ghg_total" = intv_ghg_total,
                         "intv_opex_total" = intv_opex_total,
                         "ref_boundary_mgnl" = ref_boundary_mgnl,
                         "ref_capex_total" = ref_capex_total,
                         "ref_costs_econ" = ref_costs_econ,
                         "ref_ghg_total" = ref_ghg_total,
                         "ref_opex_total" = ref_opex_total)
)

#write excel and save p1 outputs (NOTE: Change names for each parameter)

write_xlsx(ashp_outputlist, path = "ashp_output.xlsx")
write_xlsx(weatherize_outputlist, path = "weatherize_output.xlsx")
write_xlsx(hpwh_outputlist, path = "hpwh_output.xlsx")
write_xlsx(summary_outputlist, path = "summary_output.xlsx")

```

CBA Indicator calcs with discount rate range and Monte Carlo Minulation statistics
```{r}
# Calculates three seperate tables of NPV for private, economic and social costs, using the range of discount rates provided

cba_discountrange(dr_min = 0, dr_max = 7, scenario_lifetime = scenario_years)

# Calculates statistics for the Monte Carlo Simulation (lower bound, median, and upper bound)

mcs_stats(lower_bound = .25, upper_bound = .75)

```

NPV Matrix
```{r}
# Econ NPV matrix
npv_econ_medians <- data.frame(matrix(NA, nrow = 26, ncol = 71))
years <- output_headers
drcolnames <- paste0("dr",((0:70)/10))
colnames(npv_econ_medians) <- drcolnames # column headers for each discount rate: seq(0, 7, by = 0.1)
rownames(npv_econ_medians) <- years

# Social NPV matrix
npv_social_medians <- data.frame(matrix(NA, nrow = 26, ncol = 71)) 
colnames(npv_social_medians) <- drcolnames # column headers for each discount rate: seq(0, 7, by = 0.1)
rownames(npv_social_medians) <- years

# Create a cumulative sum of co-benefit value 
coben_cumsum <- as.data.frame(t(apply(coben_value_trim, 1, cumsum)))
median_coben_value <- data.frame(t(apply(coben_cumsum, 2, median))) # The median cumulative NPV value for each year is taken
median_coben_value_vector <- as.vector(unlist(median_coben_value))

for (i in 0:70) { # the loop repeats for each discount rate seq(0, 7, by = 0.1)
  drvalues <- numeric(26) # an empty vector 'drvalues' is created to house the loop outputs
  drvalues[1] <- 1        
    for (n in 2:26) {
         drvalues[n] <- (1+(i/1000))^(n-1) # drvalues is populated with the discount rate conversion factor for each year
    }
  drvalues_df <- data.frame(t(drvalues)) # make a dataframe out of the discount rate loop output
  discount_df <- drvalues_df[rep(1, run_count),] # the discount rate vector is replicated into rows equal to the MCS run count
  annual_npv_econ <- cashflow_econ/discount_df # the total annual economic cash flow is converted into NPV
  annual_npv_econ_cumsum <- as.data.frame(t(apply(annual_npv_econ, 1, cumsum))) # npv is summed cumulatively for each year
  median_npv_econ <- data.frame(t(apply(annual_npv_econ_cumsum, 2, median))) # median cumulative NPV value is taken for each year
  median_npv_vector <- as.vector(unlist(median_npv_econ))
  median_npv_social <- median_npv_vector + median_coben_value_vector# calculate the social npv
  npv_econ_medians[,i+1] <- median_npv_vector #bind the economic NPV values for the given discount rate
  npv_social_medians[,i+1] <- median_npv_social #bind the NPV social values for the given discount rate
}

```

Plot: Annual GHG Mitigation
```{r}

median_mitigation <- as.data.frame(t(apply(p1_ghg_mitigation, 2, median)))
cumulative_mitigation <- as.data.frame(t(apply(median_mitigation, 1, cumsum)))
mitigation_plot_data <- data.frame(
  Year1 = 2025:2050,
  Annual1 = unlist(median_mitigation[1,]),
  Cumulative1 = unlist(cumulative_mitigation[1,])
)

# Create the chart with a legend for cumulative and annual data
ggplot(mitigation_plot_data, aes(x = Year1)) +
  # Bar chart for cumulative data
  geom_bar(aes(y = Cumulative1, fill = "Cumulative Mitigation"), 
           stat = "identity", color = "black", width = 0.4, alpha = 0.7) +
  # Line chart for annual data
  geom_line(aes(y = Annual1 / max(Annual1) * max(Cumulative1), linetype = "Annual Mitigation"), 
            color = "black", linewidth = 1) +
  # Scale the primary y-axis and format with commas
  scale_y_continuous(
    name = "Cumulative GHG Reductions (mtco2e)",
    labels = label_comma(),  # Apply comma formatting to primary y-axis
    #breaks = seq(0, max(mitigation_plot_data$Cumulative1), by = 100),  # Adjust the 'by' parameter to control spacing
    sec.axis = sec_axis(
      ~ . * max(mitigation_plot_data$Annual1) / max(mitigation_plot_data$Cumulative1),
      name = "Annual GHG Reductions (mtco2e)",
      labels = label_comma()  # Apply comma formatting to secondary y-axis
    )
  ) +
  # Customize labels and theme
  labs(
    title = "Estimate of GHG Mitigation",
    x = "Year"
  ) +
  scale_fill_manual(values = c("Cumulative Mitigation" = "green4")) +  # Color for cumulative bars
  scale_linetype_manual(values = c("Annual Mitigation" = "dashed")) +  # Line style for annual data
  theme_minimal() +
  theme(
    legend.position = "bottom",  # Position the legend at the top
    legend.title = element_blank()  # Remove the legend title (Data Type)
  ) +
  guides(
    fill = guide_legend(title = NULL),  # Remove the legend title for fill (bars)
    linetype = guide_legend(title = NULL)  # Remove the legend title for linetype (line)
    )
```

Plot: NPV Histograms
```{r}
# Histogram of Economic NPV with 3% discount rate
npv_econ <- as.data.frame(npv_econ_dr[,30])
npv_econ_median <- npv_econ_stats[31,2]
npv_econ_lb <- npv_econ_stats[31,3]
npv_econ_ub <- npv_econ_stats[31,4]

ggplot(npv_econ, aes(x = npv_econ[,1])) +
  geom_histogram(binwidth = 20000, fill = "darkgrey", color = "black", alpha = 0.7) +
  geom_vline(aes(xintercept = npv_econ_median), color = "red", linetype = "dashed", size = 1) +  # median line
  geom_vline(aes(xintercept = npv_econ_lb), color = "green", linetype = "dotted", size = 1) +  # lower bound
  geom_vline(aes(xintercept = npv_econ_ub), color = "green", linetype = "dotted", size = 1) +  # upper bound
  labs(title = "Histogram of Economic NPV, with median and 25-75% percentiles", x = "npv", y = "Frequency") +
  scale_x_continuous(breaks = seq(-1000000, 1000000, by = 100000), labels = scales::comma) # need to adjust scales manually

# Histogram of Social NPV with 3% discount rate
npv_social <- as.data.frame(npv_social_dr[,30])
npv_social_median <- npv_social_stats[31,2]
npv_social_lb <- npv_social_stats[31,3]
npv_social_ub <- npv_social_stats[31,4]

ggplot(npv_social, aes(x = npv_social[,1])) +
  geom_histogram(binwidth = 20000, fill = "darkgrey", color = "black", alpha = 0.7) +
  geom_vline(aes(xintercept = npv_social_median), color = "red", linetype = "dashed", size = 1) +  # median line
  geom_vline(aes(xintercept = npv_social_lb), color = "green", linetype = "dotted", size = 1) +  # lower bound
  geom_vline(aes(xintercept = npv_social_ub), color = "green", linetype = "dotted", size = 1) +  # upper bound
  labs(title = "Histogram of Social NPV, with median and 25-75% percentiles", x = "npv", y = "Frequency") +
  scale_x_continuous(breaks = seq(-1000000, 1000000, by = 100000), labels = scales::comma) # need to adjust scales manually

# Overlayed NPV Histograms
set.seed(123)
npv1 <- npv_econ[,1]
npv2 <- npv_social[,1]

# Combine the two datasets into a single data frame
npvplotdf <- data.frame(
  value = c(npv1, npv2),
  Dataset = rep(c("Economic LCCA", "Social LCCA"), each = 1000)
)

# Plot two histograms on top of each other
ggplot(npvplotdf, aes(x = value, fill = Dataset)) +
  geom_histogram(alpha = 0.5, position = "identity", bins = 30) +
  geom_vline(aes(xintercept = npv_econ_median), color = "darkblue", linetype = "dashed", size = 1) +  # median line
  geom_vline(aes(xintercept = npv_social_median), color = "darkgreen", linetype = "dashed", size = 1) +  # lower bound
  scale_fill_manual(values = c("darkblue", "darkgreen")) +  # Custom colors for the two datasets
  labs(title = "Overlayed NPV Histograms with Median on Dashed Line", x = "NPV", y = "Frequency") +
  scale_x_continuous(breaks = seq(-1000000, 1000000, by = 200000), labels = scales::comma) # need to adjust scales manually

```

Plot: NPV Based on discount rate
```{r, eval = FALSE}
# Economic NPV
# Convert years to numeric for plotting
npv_econ_medians$year <- years

# Convert discount rate to numeric for plotting
npv_econ_medians$year <- as.numeric(npv_econ_medians$year)

# plot
ggplot(npv_econ_medians, aes(x = year, y = dr3)) +
  geom_line(color = "darkblue", size = 1) +                      # Line for the mean
  geom_ribbon(aes(ymin = dr0, ymax = dr7), fill = "darkblue", alpha = 0.2) +  # Shaded confidence interval
  labs(title = "NPV at a 3% Discount rate, with 0% - 7% discount rate shaded",
       x = "Year",
       y = "USD") +
  scale_y_continuous(breaks = seq(-1000000, 1000000, by = 200000),labels = comma) + # Format y-axis with commas
  theme_minimal()

# Scoial NPV
# Convert years to numeric for plotting
npv_social_medians$year <- years

# Convert discount rate to numeric for plotting
npv_social_medians$year <- as.numeric(npv_social_medians$year)

# plot
ggplot(npv_social_medians, aes(x = year, y = dr3)) +
  geom_line(color = "darkgreen", size = 1) +                      # Line for the mean
  geom_ribbon(aes(ymin = dr0, ymax = dr7), fill = "darkgreen", alpha = 0.2) +  # Shaded confidence interval
  labs(title = "NPV at a 3% Discount rate, with 0% - 7% discount rate shaded",
       x = "Year",
       y = "USD") +
  scale_y_continuous(breaks = seq(-1000000, 1000000, by = 200000),labels = comma) + # Format y-axis with commas
  theme_minimal()

# Overlayed Line Plot
# New datasets for Overlay
econnpv_overlay <- npv_econ_medians
socialnpv_overlay <- npv_social_medians

# Add group name
econnpv_overlay$group <- "Economic NPV"
socialnpv_overlay$group <- "Social NPV"

# Combine datasets
npv_overlayline_data <- rbind(econnpv_overlay, socialnpv_overlay)

# Create the plot
ggplot(npv_overlayline_data, aes(x = year, y = dr3, group = group)) +
  geom_ribbon(aes(ymin = dr2, ymax = dr4, fill = group), alpha = 0.2) +
  geom_line(aes(color = group), size = 1) +
  scale_fill_manual(values = c("Economic NPV" = "darkblue", "Social NPV" = "darkgreen")) +
  scale_color_manual(values = c("Economic NPV" = "darkblue", "Social NPV" = "darkgreen")) +
  theme_minimal() +
  scale_y_continuous(breaks = seq(-1000000, 1000000, by = 200000),labels = comma) + # Format y-axis with commas
  labs(title = "NPV at a 3% Discount rate, with 2% - 4% discount rate shaded",
       x = "Year",
       y = "USD",
       fill = "npv_overlayline_data",
       color = "npv_overlayline_data")

```

Plot: LCCA Histograms
```{r}
# Histogram of Economic NPV with 3% discount rate
lcca_econ <- as.data.frame(lcca_econ_dr[,30])
lcca_econ_median <- lcca_econ_stats[31,2]
lcca_econ_lb <- lcca_econ_stats[31,3]
lcca_econ_ub <- lcca_econ_stats[31,4]

ggplot(lcca_econ, aes(x = lcca_econ[,1])) +
  geom_histogram(binwidth = 20, fill = "blue", color = "black", alpha = 0.7) +
  geom_vline(aes(xintercept = lcca_econ_median), color = "red", linetype = "dashed", size = 1) +  # median line
  geom_vline(aes(xintercept = lcca_econ_lb), color = "green", linetype = "dotted", size = 1) +  # lower bound
  geom_vline(aes(xintercept = lcca_econ_ub), color = "green", linetype = "dotted", size = 1) +  # upper bound
  labs(title = "Histogram of Economic lcca, with median and 25-75% percentiles", x = "lcca", y = "Frequency") +
  scale_x_continuous(breaks = seq(-500, 500, by = 50), labels = scales::comma) # need to adjust scales manually

# Histogram of Social lcca with 3% discount rate
lcca_social <- as.data.frame(lcca_social_dr[,30])
lcca_social_median <- lcca_social_stats[31,2]
lcca_social_lb <- lcca_social_stats[31,3]
lcca_social_ub <- lcca_social_stats[31,4]

ggplot(lcca_social, aes(x = lcca_social[,1])) +
  geom_histogram(binwidth = 20, fill = "blue", color = "black", alpha = 0.7) +
  geom_vline(aes(xintercept = lcca_social_median), color = "red", linetype = "dashed", size = 1) +  # median line
  geom_vline(aes(xintercept = lcca_social_lb), color = "green", linetype = "dotted", size = 1) +  # lower bound
  geom_vline(aes(xintercept = lcca_social_ub), color = "green", linetype = "dotted", size = 1) +  # upper bound
  labs(title = "Histogram of Social lcca, with median and 25-75% percentiles", x = "lcca", y = "Frequency") +
  scale_x_continuous(breaks = seq(-500, 500, by = 50), labels = scales::comma) # need to adjust scales manually

# Overlayed lcca Histograms
set.seed(123)
lcca1 <- lcca_econ[,1]
lcca2 <- lcca_social[,1]

# Combine the two datasets into a single data frame
lccaplotdf <- data.frame(
  value = c(lcca1, lcca2),
  Dataset = rep(c("Economic LCCA", "Social LCCA"), each = 1000)
)

# Plot two histograms on top of each other
ggplot(lccaplotdf, aes(x = value, fill = Dataset)) +
  geom_histogram(alpha = 0.5, position = "identity", bins = 30) +
  geom_vline(aes(xintercept = lcca_econ_median), color = "darkblue", linetype = "dashed", size = 1) +  # median line
  geom_vline(aes(xintercept = lcca_social_median), color = "darkgreen", linetype = "dashed", size = 1) +  # lower bound
  scale_fill_manual(values = c("darkblue", "darkgreen")) +  # Custom colors for the two datasets
  labs(title = "Overlayed LCCA Histograms with Median on Dashed Line", x = "Value", y = "Frequency") +
  scale_x_continuous(breaks = seq(-500, 500, by = 100), labels = scales::comma) # need to adjust scales manually

```

Plot: LCCA Based on discount rate
```{r, eval = FALSE}
# Economic LCCA
# Convert discount rate to numeric for plotting
lcca_econ_stats$DR <- as.numeric(lcca_econ_stats$DR)

# Filter the confidence results to get rid of any years with zero lcca
plot2_data <- subset(lcca_econ_stats, Median != 0)

# plot
ggplot(plot2_data, aes(x = DR, y = Median)) +
  geom_line(color = "darkblue", size = 1) +                      # Line for the mean
  geom_ribbon(aes(ymin = Lower, ymax = Upper), fill = "darkblue", alpha = 0.2) +  # Shaded confidence interval
  labs(title = "Median, with 25-75% percentile range shaded",
       x = "Discount Rate",
       y = "LCCA") +
  theme_minimal()

# Scoial LCCA
# Convert discount rate to numeric for plotting
lcca_social_stats$DR <- as.numeric(lcca_social_stats$DR)

# Filter the confidence results to get rid of any years with zero lcca
plot3_data <- subset(lcca_econ_stats, Median != 0)

# plot
ggplot(plot3_data, aes(x = DR, y = Median)) +
  geom_line(color = "darkgreen", size = 1) +                      # Line for the mean
  geom_ribbon(aes(ymin = Lower, ymax = Upper), fill = "darkgreen", alpha = 0.2) +  # Shaded confidence interval
  labs(title = "Median, with 25-75% percentile range shaded",
       x = "Discount Rate",
       y = "LCCA") +
  theme_minimal()

# Overlayed Line Plot
# Convert discount rate to numeric for plotting
lcca_econ_stats$DR <- as.numeric(lcca_econ_stats$DR)
lcca_social_stats$DR <- as.numeric(lcca_social_stats$DR)

# Filter the confidence results to get rid of any years with zero lcca
econlcca_linedata <- subset(lcca_econ_stats, Median != 0)
sociallcca_line_data <- subset(lcca_social_stats, Median != 0)

# Add group name
econlcca_linedata$group <- "Economic LCCA"
sociallcca_line_data$group <- "Social LCCA"

# Combine datasets
overlayline_data <- rbind(econlcca_linedata, sociallcca_line_data)

# Create the plot
ggplot(overlayline_data, aes(x = DR, y = Median, group = group)) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = group), alpha = 0.2) +
  geom_line(aes(color = group), size = 1) +
  scale_fill_manual(values = c("Economic LCCA" = "darkblue", "Social LCCA" = "darkgreen")) +
  scale_color_manual(values = c("Economic LCCA" = "darkblue", "Social LCCA" = "darkgreen")) +
  theme_minimal() +
  labs(title = "Median LCCA, with 25-75% percentile range shaded",
       x = "Discount Rate",
       y = "LCCA",
       fill = "overlayline_data",
       color = "overlayline_data")

```